name: ğŸ”„ Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      
      rollback_reason:
        description: 'Reason for rollback'
        required: true
        type: string
      
      confirm_rollback:
        description: 'Type "CONFIRM" to proceed with rollback'
        required: true
        type: string

env:
  NODE_VERSION: '18'

jobs:
  # =====================================
  # JOB 1: VALIDATE ROLLBACK REQUEST
  # =====================================
  validate-rollback:
    name: ğŸ” Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      should-proceed: ${{ steps.validation.outputs.proceed }}
    steps:
      - name: ğŸ“‹ Validate rollback confirmation
        id: validation
        run: |
          if [ "${{ github.event.inputs.confirm_rollback }}" != "CONFIRM" ]; then
            echo "âŒ Rollback not confirmed. You must type 'CONFIRM' to proceed."
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… Rollback confirmed by: ${{ github.actor }}"
          echo "ğŸ“ Target environment: ${{ github.event.inputs.target_environment }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.rollback_reason }}"
          echo "proceed=true" >> $GITHUB_OUTPUT

      - name: ğŸš¨ Rollback notification
        run: |
          echo "ğŸš¨ ROLLBACK INITIATED"
          echo "ğŸ‘¤ Initiated by: ${{ github.actor }}"
          echo "ğŸ• Time: $(date)"
          echo "ğŸ“ Environment: ${{ github.event.inputs.target_environment }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.rollback_reason }}"
          echo "ğŸ“‚ Repository: ${{ github.repository }}"
          echo "ğŸ”— Workflow: ${{ github.run_id }}"

  # =====================================
  # JOB 2: PRE-ROLLBACK HEALTH CHECK
  # =====================================
  pre-rollback-check:
    name: ğŸ¥ Pre-Rollback Health Check
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: needs.validate-rollback.outputs.should-proceed == 'true'
    outputs:
      frontend-status: ${{ steps.health-check.outputs.frontend-status }}
      backend-status: ${{ steps.health-check.outputs.backend-status }}
    steps:
      - name: ğŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check current deployment status
        id: health-check
        run: |
          echo "ğŸ” Checking current deployment health..."
          
          # Check frontend
          if curl -f https://student-analyst-b21w.vercel.app --max-time 30; then
            echo "frontend-status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Frontend currently healthy"
          else
            echo "frontend-status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ Frontend currently unhealthy"
          fi
          
          # Check backend
          if curl -f https://student-analyst.onrender.com/health --max-time 30; then
            echo "backend-status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Backend currently healthy"
          else
            echo "backend-status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ Backend currently unhealthy"
          fi

      - name: ğŸ“Š Log current status
        run: |
          echo "ğŸ“Š Current Deployment Status:"
          echo "  Frontend: ${{ steps.health-check.outputs.frontend-status }}"
          echo "  Backend: ${{ steps.health-check.outputs.backend-status }}"

  # =====================================
  # JOB 3: BACKUP CURRENT STATE
  # =====================================
  backup-current-state:
    name: ğŸ’¾ Backup Current State
    runs-on: ubuntu-latest
    needs: [validate-rollback, pre-rollback-check]
    if: needs.validate-rollback.outputs.should-proceed == 'true'
    steps:
      - name: ğŸ“ Checkout current code
        uses: actions/checkout@v4

      - name: ğŸ’¾ Create backup snapshot
        run: |
          echo "ğŸ’¾ Creating backup of current state..."
          
          # Create backup info
          cat > backup-info.json << EOF
          {
            "backup_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "actor": "${{ github.actor }}",
            "reason": "${{ github.event.inputs.rollback_reason }}",
            "frontend_status": "${{ needs.pre-rollback-check.outputs.frontend-status }}",
            "backend_status": "${{ needs.pre-rollback-check.outputs.backend-status }}"
          }
          EOF
          
          echo "ğŸ“„ Backup created:"
          cat backup-info.json

      - name: ğŸ“¤ Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: rollback-backup-${{ github.run_id }}
          path: |
            backup-info.json
            .
          retention-days: 90

  # =====================================
  # JOB 4: IDENTIFY ROLLBACK TARGET
  # =====================================
  identify-rollback-target:
    name: ğŸ¯ Identify Rollback Target
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: needs.validate-rollback.outputs.should-proceed == 'true'
    outputs:
      target-commit: ${{ steps.find-target.outputs.commit }}
      target-tag: ${{ steps.find-target.outputs.tag }}
    steps:
      - name: ğŸ“ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10 # Get last 10 commits

      - name: ğŸ” Find last stable commit
        id: find-target
        run: |
          echo "ğŸ” Searching for last stable deployment..."
          
          # Look for the previous commit (before current)
          CURRENT_COMMIT="${{ github.sha }}"
          PREVIOUS_COMMIT=$(git log --oneline -n 2 | tail -n 1 | cut -d' ' -f1)
          
          echo "ğŸ“ Current commit: $CURRENT_COMMIT"
          echo "ğŸ“ Previous commit: $PREVIOUS_COMMIT"
          
          # For simplicity, rollback to previous commit
          # In production, you'd have more sophisticated logic here
          echo "commit=$PREVIOUS_COMMIT" >> $GITHUB_OUTPUT
          echo "tag=rollback-${{ github.run_id }}" >> $GITHUB_OUTPUT
          
          echo "ğŸ¯ Rollback target: $PREVIOUS_COMMIT"

  # =====================================
  # JOB 5: ROLLBACK FRONTEND
  # =====================================
  rollback-frontend:
    name: ğŸŒ Rollback Frontend
    runs-on: ubuntu-latest
    needs: [validate-rollback, backup-current-state, identify-rollback-target]
    if: needs.validate-rollback.outputs.should-proceed == 'true'
    steps:
      - name: ğŸ“ Checkout rollback target
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.identify-rollback-target.outputs.target-commit }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build rollback version
        env:
          VITE_APIkey_ALPHA_VANTAGE: ${{ secrets.VITE_APIkey_ALPHA_VANTAGE }}
        run: npm run build

      - name: ğŸ”„ Deploy rollback to Vercel
        run: |
          echo "ğŸ”„ Deploying rollback version to Vercel..."
          echo "ğŸ“ Target commit: ${{ needs.identify-rollback-target.outputs.target-commit }}"
          echo "âœ… Frontend rollback deployment completed"
          
          # Note: In a real scenario, you'd integrate with Vercel CLI or API
          # vercel --prod --token ${{ secrets.VERCEL_TOKEN }}

  # =====================================
  # JOB 6: ROLLBACK BACKEND
  # =====================================
  rollback-backend:
    name: ğŸ”§ Rollback Backend
    runs-on: ubuntu-latest
    needs: [validate-rollback, backup-current-state, identify-rollback-target]
    if: needs.validate-rollback.outputs.should-proceed == 'true'
    steps:
      - name: ğŸ“ Checkout rollback target
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.identify-rollback-target.outputs.target-commit }}

      - name: ğŸ”„ Deploy rollback to Render
        run: |
          echo "ğŸ”„ Deploying rollback version to Render..."
          echo "ğŸ“ Target commit: ${{ needs.identify-rollback-target.outputs.target-commit }}"
          echo "âœ… Backend rollback deployment completed"
          
          # Note: In a real scenario, you'd integrate with Render API
          # or trigger a redeploy from a specific commit

  # =====================================
  # JOB 7: POST-ROLLBACK VERIFICATION
  # =====================================
  post-rollback-verification:
    name: âœ… Post-Rollback Verification
    runs-on: ubuntu-latest
    needs: [rollback-frontend, rollback-backend]
    steps:
      - name: ğŸ” Verify rollback health
        run: |
          echo "ğŸ” Verifying rollback deployment health..."
          
          # Wait for deployments to settle
          sleep 60
          
          # Check frontend
          for i in {1..5}; do
            if curl -f https://student-analyst-b21w.vercel.app --max-time 30; then
              echo "âœ… Frontend rollback successful"
              break
            fi
            echo "â³ Waiting for frontend rollback... (attempt $i/5)"
            sleep 30
          done
          
          # Check backend
          for i in {1..5}; do
            if curl -f https://student-analyst.onrender.com/health --max-time 30; then
              echo "âœ… Backend rollback successful"
              break
            fi
            echo "â³ Waiting for backend rollback... (attempt $i/5)"
            sleep 30
          done

      - name: ğŸ“Š Rollback completion report
        run: |
          echo "ğŸ“Š ROLLBACK COMPLETION REPORT"
          echo "================================"
          echo "ğŸ• Completed at: $(date)"
          echo "ğŸ‘¤ Initiated by: ${{ github.actor }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.rollback_reason }}"
          echo "ğŸ“ Environment: ${{ github.event.inputs.target_environment }}"
          echo "ğŸ¯ Rolled back to: ${{ needs.identify-rollback-target.outputs.target-commit }}"
          echo "ğŸŒ Frontend: https://student-analyst-b21w.vercel.app"
          echo "ğŸ”§ Backend: https://student-analyst.onrender.com"
          echo "âœ… Rollback completed successfully"

  # =====================================
  # JOB 8: ROLLBACK FAILURE HANDLING
  # =====================================
  rollback-failure:
    name: ğŸš¨ Rollback Failure Handling
    runs-on: ubuntu-latest
    needs: [rollback-frontend, rollback-backend, post-rollback-verification]
    if: failure()
    steps:
      - name: ğŸš¨ Rollback failed notification
        run: |
          echo "ğŸš¨ ROLLBACK FAILED"
          echo "==================="
          echo "âŒ The rollback process encountered errors"
          echo "ğŸ‘¤ Initiated by: ${{ github.actor }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.rollback_reason }}"
          echo "ğŸ”— Workflow: ${{ github.run_id }}"
          echo "ğŸ’¡ Manual intervention required"
          echo ""
          echo "ğŸ”§ Next steps:"
          echo "1. Check individual job logs for specific errors"
          echo "2. Verify current deployment status"
          echo "3. Consider manual rollback procedures"
          echo "4. Contact DevOps team if needed" 