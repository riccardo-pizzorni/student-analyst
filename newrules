# üÜï NUOVE REGOLE - STUDENT ANALYST

> **‚ö†Ô∏è REGOLE APPRESE DURANTE LO SVILUPPO** | [Componenti Analisi](#componenti-analisi) | [Validazione Dati](#validazione-dati)

---

## üö® REGOLE ANTI-REGRESSIONE E DEPLOY STATICI (2024-06)

### **Static Assets & Vercel - SEMPRE OBBLIGATORIO**

- **Verifica SEMPRE** che la configurazione Vercel (`vercel.json`) abbia la chiave `outputDirectory` corretta (es: `"dist"` per Vite) quando usi build tools che non producono output in `public/`.
- **Testa SEMPRE** la raggiungibilit√† di almeno un file statico di test (es: `/logo-test.txt`, `/lovable-uploads/debug-logo.txt`) dopo ogni deploy.
- **Non dare MAI per scontato** che la presenza dei file in `dist/` o `public/` localmente implichi che saranno serviti da Vercel: controlla sempre la root di deploy e la configurazione.
- **Se un asset non si vede ma la build √® corretta**, controlla subito: outputDirectory, root di progetto su Vercel, e la presenza reale del file via URL pubblico.
- **Se un file statico non viene servito, NON modificare il codice React/JSX**: il problema √® quasi sempre di deploy/config.
- **Quando sostituisci asset binari (es: PNG)**, verifica che siano validi e non corrotti sia localmente che dopo il deploy (apri l'URL diretto!).
- **Documenta sempre** la soluzione definitiva nel repo (README o regole) per evitare ricadute future.

### **UI/UX Component Regression - SEMPRE OBBLIGATORIO**

- **Non sostituire MAI componenti custom (es: Select, Dropdown, DatePicker) con elementi HTML nativi** senza motivazione e test visivo: causa regressioni di stile e UX.
- **Quando modifichi un input o una select, verifica SEMPRE che il look sia coerente con il resto dell'app** (soprattutto dopo merge o refactor).
- **Se usi una libreria UI (Shadcn, Radix, HeadlessUI, ecc.), preferisci SEMPRE i componenti custom rispetto agli elementi nativi** per coerenza visiva e accessibilit√†.
- **Dopo ogni refactor di componenti UI, testa manualmente i flussi principali** e confronta con screenshot precedenti.
- **Aggiungi test visivi o screenshot di riferimento** per i componenti critici (dropdown, sidebar, logo, ecc.).
- **Se noti una regressione, ripristina subito il componente custom** e documenta la causa per evitare errori simili.

---

## üß© COMPONENTI ANALISI

### **Protezione Valori Undefined - SEMPRE OBBLIGATORIA**

**Regola**: Ogni modifica futura ai componenti di analisi deve includere protezione contro valori undefined e validazione dei dati.

**Motivazione**: Evita errori `TypeError: Cannot read properties of undefined (reading 'toFixed')` e crash dell'applicazione.

**Implementazione**:

```typescript
// ‚úÖ CORRETTO - Protezione contro undefined
{metric.label || 'Metrica'}
{metric.value || '0%'}
${ticker.price?.toFixed(2) || '0.00'}
{sharpeRatio?.toFixed(2) || '0.00'}

// ‚ùå SBAGLIATO - Nessuna protezione
{metric.label}
{metric.value}
${ticker.price.toFixed(2)}
{sharpeRatio.toFixed(2)}
```

**Checklist Pre-Commit**:

- [ ] Tutti i valori numerici hanno protezione `?.` o `||`
- [ ] Tutti i valori stringa hanno fallback
- [ ] Tutti i valori array hanno `|| []`
- [ ] Tutti i valori oggetto hanno `|| {}`
- [ ] Testato con dati undefined/null

---

## üîí VALIDAZIONE DATI

### **Validazione Context - SEMPRE OBBLIGATORIA**

**Regola**: Validare sempre i dati prima di salvarli nel context per evitare errori runtime.

**Implementazione**:

```typescript
// Validazione risultati prima di salvarli
const validatedResults = {
  ...results,
  performanceMetrics:
    results.performanceMetrics?.map(metric => ({
      label: metric.label || 'Metrica',
      value: metric.value || '0%',
    })) || [],
  volatility: results.volatility
    ? {
        annualizedVolatility: results.volatility.annualizedVolatility || 0,
        sharpeRatio: results.volatility.sharpeRatio || 0,
      }
    : null,
  correlation: results.correlation
    ? {
        correlationMatrix: results.correlation.correlationMatrix || {
          symbols: [],
          matrix: [],
        },
        diversificationIndex: results.correlation.diversificationIndex || 0,
        averageCorrelation: results.correlation.averageCorrelation || 0,
      }
    : null,
};
```

---

## üö´ CHIAMATE MULTIPLE

### **Protezione API Calls - SEMPRE OBBLIGATORIA**

**Regola**: Prevenire sempre chiamate API multiple con flag di stato non reattivo.

**Implementazione**:

```typescript
const isAnalysisRunning = useRef(false);

const startAnalysis = async () => {
  if (isAnalysisRunning.current) {
    console.log('üö´ Analisi gi√† in corso, ignoro chiamata multipla');
    return;
  }

  isAnalysisRunning.current = true;
  try {
    // ... logica analisi
  } finally {
    isAnalysisRunning.current = false;
  }
};
```

---

## üéØ REGOLE FINALI

1. **Ogni componente di analisi DEVE avere protezione contro undefined**
2. **Ogni context DEVE validare i dati prima di salvarli**
3. **Ogni funzione async DEVE prevenire chiamate multiple**
4. **Ogni valore numerico DEVE avere fallback per toFixed()**
5. **Ogni modifica DEVE essere testata con dati edge case**

**‚ö†Ô∏è IMPORTANTE**: Queste regole sono critiche per la stabilit√† dell'applicazione. Non ignorare mai.
